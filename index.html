<!doctype html>
<html lang="es-MX">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Mis Gastos</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#9fb0d0;
      --text:#e9eefc;
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --ok:#3ddc97;
      --border:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1000px 700px at 40% -10%, rgba(122,162,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 110% 30%, rgba(61,220,151,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(11,18,32,.75);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--border);
      padding: 14px 14px 10px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .space{justify-content:space-between}
    .title{font-weight:800; letter-spacing:.2px; font-size:18px}
    .pill{
      padding:8px 10px; border:1px solid var(--border); border-radius:999px;
      color:var(--muted); font-size:12px;
    }
    main{padding:14px; max-width:980px; margin:0 auto}
    .grid{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media (min-width: 820px){ .grid{grid-template-columns: 1.2fr .8fr} }

    .card{
      background: rgba(17,26,46,.80);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:14px 14px 0; font-size:14px; color:var(--muted); font-weight:700;
      letter-spacing:.2px;
    }
    .card .content{padding:12px 14px 14px}

    .big{font-size:34px; font-weight:900; line-height:1.05; letter-spacing:-.4px;}
    .sub{color:var(--muted); font-size:12px; margin-top:6px}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      cursor:pointer;
      transition: transform .05s ease;
      user-select:none;
    }
    .btn:active{transform: scale(.99)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(122,162,255,.55));
      border-color: rgba(122,162,255,.6);
      color:#071028;
    }
    .btn.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.35);
      color: var(--text);
    }
    .btn.ok{
      background: rgba(61,220,151,.12);
      border-color: rgba(61,220,151,.35);
      color: var(--text);
    }
    .btn.small{padding:8px 10px; border-radius: 10px; font-size:12px}
    .btn.ghost{background: transparent}

    .input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    label{display:block; font-size:12px; color:var(--muted); margin: 8px 0 6px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .three{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,.04);
    }
    .item .top{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted);
      background: rgba(0,0,0,.10);
    }
    .amt{font-weight:900; font-size:16px}
    .meta{font-size:12px; color:var(--muted); margin-top:4px}
    .sep{height:1px; background: var(--border); margin:10px 0}
    .hint{font-size:12px; color:var(--muted)}

    .kpiRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .kpi{
      flex:1;
      min-width: 160px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background: rgba(255,255,255,.04);
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-weight:900; margin-top:6px}

    /* Drawer (menu plegable) */
    .drawerOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:200;
    }
    .drawerOverlay.open{display:block}
    .drawer{
      position:fixed; top:0; left:0; height:100%;
      width: 290px; max-width: 85vw;
      background: rgba(17,26,46,.98);
      border-right:1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(-102%);
      transition: transform .18s ease;
      z-index:210;
      padding: 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .drawer.open{transform: translateX(0)}
    .navBtn{
      width:100%;
      text-align:left;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
    }
    .navBtn.active{
      border-color: rgba(122,162,255,.65);
      background: rgba(122,162,255,.12);
    }
    .navSub{font-size:12px; color:var(--muted); margin-top:4px; font-weight:600}
    .drawerTop{display:flex; align-items:center; justify-content:space-between}
    .hamburger{
      width:40px; height:40px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .hamburger span{font-size:20px; line-height:0}

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none;
      background: rgba(0,0,0,.55);
      padding: 16px;
      z-index:300;
    }
    .modal.open{display:flex; align-items:flex-end}
    @media (min-width: 820px){
      .modal.open{align-items:center; justify-content:center}
    }
    .modal .panel{
      width:100%; max-width:720px;
      background: rgba(17,26,46,.95);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel header{
      position:relative;
      background: transparent;
      border-bottom:1px solid var(--border);
      padding: 12px 14px;
    }
    .panel .body{padding: 12px 14px 14px}
    .right{display:flex; justify-content:flex-end; gap:10px}

    .hidden{display:none !important}
  </style>
</head>

<body>
  <header>
    <div class="row space">
      <div class="row">
        <div class="hamburger" id="btnMenu" title="Menú"><span>☰</span></div>
        <div>
          <div class="title" id="headerTitle">Mis Gastos</div>
          <div class="pill" id="monthLabel"></div>
        </div>
      </div>

      <div class="row">
        <button class="btn small" id="btnExport">Exportar</button>
        <button class="btn small" id="btnImport">Importar</button>
        <button class="btn primary" id="btnAdd">+ Gasto</button>
      </div>
    </div>
  </header>

  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerTop">
      <div style="font-weight:900">Menú</div>
      <button class="btn small ghost" id="btnCloseMenu">Cerrar</button>
    </div>

    <button class="navBtn active" id="navHome">
      Movimientos
      <div class="navSub">Resumen mensual + lista</div>
    </button>

    <button class="navBtn" id="navFixed">
      Gastos fijos
      <div class="navSub">Netflix, Spotify, Teléfono…</div>
    </button>

    <button class="navBtn" id="navMSI">
      Meses sin intereses
      <div class="navSub">Cuotas y meses faltantes</div>
    </button>

    <div class="sep"></div>
    <div class="hint">
      Todo es offline. Si cambias de cel, usa <b>Exportar</b> y luego <b>Importar</b>.
    </div>

    <div style="margin-top:auto">
      <button class="btn danger" id="btnClearAll" style="width:100%">Borrar todo</button>
    </div>
  </aside>

  <main>
    <!-- VIEW: HOME -->
    <section id="viewHome">
      <div class="grid">
        <section class="card">
          <h2>Resumen del mes</h2>
          <div class="content">
            <div class="big" id="monthTotal">$0</div>
            <div class="sub" id="monthSub">0 movimientos</div>

            <div class="kpiRow">
              <div class="kpi">
                <div class="label">Efectivo</div>
                <div class="value" id="kpiCash">$0</div>
              </div>
              <div class="kpi">
                <div class="label">Débito</div>
                <div class="value" id="kpiDebit">$0</div>
              </div>
              <div class="kpi">
                <div class="label">Crédito</div>
                <div class="value" id="kpiCredit">$0</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row" style="gap:12px">
              <div style="flex:1; min-width:220px">
                <label>Buscar (concepto)</label>
                <input class="input" id="q" placeholder="Ej: uber, oxxo, comida..." />
              </div>

              <div style="flex:1; min-width:180px">
                <label>Método</label>
                <select id="fMethod">
                  <option value="">Todos</option>
                  <option value="cash">Efectivo</option>
                  <option value="debit">Débito</option>
                  <option value="credit">Crédito</option>
                </select>
              </div>

              <div style="flex:1; min-width:180px">
                <label>Fue de</label>
                <select id="fOwner">
                  <option value="">Todos</option>
                  <option value="me">Yo</option>
                  <option value="mom">Mamá</option>
                  <option value="sis">Hermana</option>
                  <option value="partner">Pareja</option>
                  <option value="other">Otro</option>
                </select>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row space">
              <div class="hint">Tip: registra rápido con <b>+ Gasto</b>.</div>
              <button class="btn ok small" id="btnGenFixedThisMonth" title="Genera los pagos fijos del mes como movimientos">
                Generar fijos del mes
              </button>
            </div>
          </div>
        </section>

        <section class="card">
          <h2>Movimientos (mes actual)</h2>
          <div class="content">
            <div class="list" id="list"></div>
            <div class="hint" id="emptyHint" style="display:none; margin-top:10px">
              Aún no hay movimientos. Dale a <b>+ Gasto</b>.
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- VIEW: FIXED -->
    <section id="viewFixed" class="hidden">
      <section class="card">
        <h2>Gastos fijos</h2>
        <div class="content">
          <div class="row space">
            <div class="hint">Ej: Netflix, Spotify, Teléfono… (se pueden generar como movimiento cada mes)</div>
            <button class="btn primary" id="btnAddFixed">+ Fijo</button>
          </div>

          <div class="sep"></div>
          <div class="list" id="fixedList"></div>
          <div class="hint" id="fixedEmpty" style="display:none;margin-top:10px">Aún no agregas gastos fijos.</div>
        </div>
      </section>
    </section>

    <!-- VIEW: MSI -->
    <section id="viewMSI" class="hidden">
      <section class="card">
        <h2>Meses sin intereses (MSI)</h2>
        <div class="content">
          <div class="row space">
            <div class="hint">Aquí llevas pagos mensuales y cuántos meses faltan.</div>
            <button class="btn primary" id="btnAddMSI">+ MSI</button>
          </div>

          <div class="sep"></div>
          <div class="list" id="msiList"></div>
          <div class="hint" id="msiEmpty" style="display:none;margin-top:10px">Aún no agregas compras a meses.</div>
        </div>
      </section>
    </section>
  </main>

  <!-- Modal: Add Expense -->
  <div class="modal" id="modalExpense">
    <div class="panel">
      <header class="row space">
        <div class="title">Agregar gasto</div>
        <button class="btn small ghost" id="btnCloseExpense">Cerrar</button>
      </header>
      <div class="body">
        <div class="two">
          <div>
            <label>Monto</label>
            <input class="input" id="amount" inputmode="decimal" placeholder="Ej: 250" />
          </div>
          <div>
            <label>Fecha</label>
            <input class="input" id="date" type="date" />
          </div>
        </div>

        <label>Concepto</label>
        <input class="input" id="concept" placeholder="Ej: gasolina, uber, comida..." />

        <div class="three" style="margin-top:6px">
          <div>
            <label>Método</label>
            <select id="method">
              <option value="cash">Efectivo</option>
              <option value="debit">Débito</option>
              <option value="credit">Crédito</option>
            </select>
          </div>
          <div>
            <label>¿Quién pagó?</label>
            <select id="payer">
              <option value="me">Yo</option>
              <option value="mom">Mamá</option>
              <option value="sis">Hermana</option>
              <option value="partner">Pareja</option>
              <option value="other">Otro</option>
            </select>
          </div>
          <div>
            <label>¿De quién fue el gasto?</label>
            <select id="owner">
              <option value="me">Yo</option>
              <option value="mom">Mamá</option>
              <option value="sis">Hermana</option>
              <option value="partner">Pareja</option>
              <option value="other">Otro</option>
            </select>
          </div>
        </div>

        <label>Notas (opcional)</label>
        <input class="input" id="note" placeholder="Ej: pagué con mi tarjeta, me lo regresan después..." />

        <div class="right" style="margin-top:12px">
          <button class="btn" id="btnSaveExpense">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add Fixed -->
  <div class="modal" id="modalFixed">
    <div class="panel">
      <header class="row space">
        <div class="title">Agregar gasto fijo</div>
        <button class="btn small ghost" id="btnCloseFixed">Cerrar</button>
      </header>
      <div class="body">
        <div class="two">
          <div>
            <label>Nombre</label>
            <input class="input" id="fixedName" placeholder="Ej: Netflix" />
          </div>
          <div>
            <label>Monto</label>
            <input class="input" id="fixedAmount" inputmode="decimal" placeholder="Ej: 199" />
          </div>
        </div>

        <div class="two" style="margin-top:6px">
          <div>
            <label>Día de cobro</label>
            <input class="input" id="fixedDay" type="number" min="1" max="31" placeholder="Ej: 10" />
          </div>
          <div>
            <label>Método</label>
            <select id="fixedMethod">
              <option value="cash">Efectivo</option>
              <option value="debit">Débito</option>
              <option value="credit">Crédito</option>
            </select>
          </div>
        </div>

        <div class="right" style="margin-top:12px">
          <button class="btn" id="btnSaveFixed">Guardar</button>
        </div>

        <div class="hint" style="margin-top:10px">
          * Luego puedes darle “Generar fijos del mes” para que se agreguen como movimientos.
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add MSI -->
  <div class="modal" id="modalMSI">
    <div class="panel">
      <header class="row space">
        <div class="title">Agregar MSI</div>
        <button class="btn small ghost" id="btnCloseMSI">Cerrar</button>
      </header>
      <div class="body">
        <label>Nombre</label>
        <input class="input" id="msiName" placeholder="Ej: Celular" />

        <div class="two">
          <div>
            <label>Pago mensual</label>
            <input class="input" id="msiMonthly" inputmode="decimal" placeholder="Ej: 850" />
          </div>
          <div>
            <label>Meses totales</label>
            <input class="input" id="msiTotal" type="number" min="1" placeholder="Ej: 12" />
          </div>
        </div>

        <div class="two" style="margin-top:6px">
          <div>
            <label>Meses pagados (inicial)</label>
            <input class="input" id="msiPaid" type="number" min="0" placeholder="Ej: 0" />
          </div>
          <div>
            <label>Método</label>
            <select id="msiMethod">
              <option value="credit">Crédito</option>
              <option value="debit">Débito</option>
              <option value="cash">Efectivo</option>
            </select>
          </div>
        </div>

        <div class="right" style="margin-top:12px">
          <button class="btn" id="btnSaveMSI">Guardar</button>
        </div>

        <div class="hint" style="margin-top:10px">
          * El botón “Pagar mes” agregará un movimiento de este mes y avanzará 1 mes pagado.
        </div>
      </div>
    </div>
  </div>

  <!-- Import file input (hidden) -->
  <input type="file" id="file" accept="application/json" style="display:none" />

  <script>
    /**************
     * Utilities
     **************/
    const fmtMoney = (n) => new Intl.NumberFormat("es-MX", { style:"currency", currency:"MXN" }).format(n || 0);
    const pad2 = (x) => String(x).padStart(2,"0");
    const todayISO = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const monthKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; // YYYY-MM
    const currentMonthKey = () => monthKey(new Date());
    const currentYearMonth = () => {
      const d = new Date();
      return { y: d.getFullYear(), m: d.getMonth()+1 };
    };

    const PERSON = { me:"Yo", mom:"Mamá", sis:"Hermana", partner:"Pareja", other:"Otro" };
    const METHOD = { cash:"Efectivo", debit:"Débito", credit:"Crédito" };

    const el = (id) => document.getElementById(id);
    const parseAmount = (v) => {
      const clean = String(v).replace(/[^\d.]/g,"");
      const n = Number(clean);
      return Number.isFinite(n) ? n : NaN;
    };
    const uid = () => `${Date.now()}_${Math.random().toString(16).slice(2)}`;

    /**************
     * IndexedDB (v2: tx + fixed + msi)
     **************/
    const DB_NAME = "gastos_pwa_v2";
    const DB_VER = 2;
    const STORE_TX = "tx";
    const STORE_FIXED = "fixed";
    const STORE_MSI = "msi";

    let db;

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);

        req.onupgradeneeded = () => {
          const db = req.result;

          if(!db.objectStoreNames.contains(STORE_TX)){
            const os = db.createObjectStore(STORE_TX, { keyPath: "id" });
            os.createIndex("by_date", "dateISO", { unique:false });
            os.createIndex("by_month", "month", { unique:false });
          }
          if(!db.objectStoreNames.contains(STORE_FIXED)){
            const os = db.createObjectStore(STORE_FIXED, { keyPath: "id" });
            os.createIndex("by_active", "active", { unique:false });
          }
          if(!db.objectStoreNames.contains(STORE_MSI)){
            const os = db.createObjectStore(STORE_MSI, { keyPath: "id" });
            os.createIndex("by_active", "active", { unique:false });
          }
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function dbGetAll(store){
      return new Promise((resolve, reject) => {
        const r = db.transaction(store, "readonly").objectStore(store).getAll();
        r.onsuccess = () => resolve(r.result || []);
        r.onerror = () => reject(r.error);
      });
    }
    function dbPut(store, obj){
      return new Promise((resolve, reject) => {
        const r = db.transaction(store, "readwrite").objectStore(store).put(obj);
        r.onsuccess = () => resolve(true);
        r.onerror = () => reject(r.error);
      });
    }
    function dbDel(store, id){
      return new Promise((resolve, reject) => {
        const r = db.transaction(store, "readwrite").objectStore(store).delete(id);
        r.onsuccess = () => resolve(true);
        r.onerror = () => reject(r.error);
      });
    }
    function dbClearAll(){
      return Promise.all([
        new Promise((res, rej)=>{ const r=db.transaction(STORE_TX,"readwrite").objectStore(STORE_TX).clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
        new Promise((res, rej)=>{ const r=db.transaction(STORE_FIXED,"readwrite").objectStore(STORE_FIXED).clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
        new Promise((res, rej)=>{ const r=db.transaction(STORE_MSI,"readwrite").objectStore(STORE_MSI).clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
      ]);
    }

    /**************
     * State
     **************/
    let txAll = [];
    let fixedAll = [];
    let msiAll = [];

    /**************
     * Drawer navigation
     **************/
    function openDrawer(){
      el("drawer").classList.add("open");
      el("drawerOverlay").classList.add("open");
    }
    function closeDrawer(){
      el("drawer").classList.remove("open");
      el("drawerOverlay").classList.remove("open");
    }

    function setActiveNav(nav){
      const navs = ["navHome","navFixed","navMSI"];
      navs.forEach(id => el(id).classList.toggle("active", id === nav));

      el("viewHome").classList.toggle("hidden", nav !== "navHome");
      el("viewFixed").classList.toggle("hidden", nav !== "navFixed");
      el("viewMSI").classList.toggle("hidden", nav !== "navMSI");

      const title =
        nav === "navHome" ? "Mis Gastos" :
        nav === "navFixed" ? "Gastos fijos" :
        "Meses sin intereses";

      el("headerTitle").textContent = title;
      closeDrawer();

      if(nav === "navFixed") renderFixed();
      if(nav === "navMSI") renderMSI();
      if(nav === "navHome") renderHome();
    }

    /**************
     * Home (movimientos)
     **************/
    function setMonthLabel(){
      const now = new Date();
      const label = now.toLocaleDateString("es-MX", { month:"long", year:"numeric" });
      el("monthLabel").textContent = label.charAt(0).toUpperCase() + label.slice(1);
    }

    function computeMonthStats(items){
      let total = 0, cash=0, debit=0, credit=0;
      for(const x of items){
        total += x.amount;
        if(x.method === "cash") cash += x.amount;
        if(x.method === "debit") debit += x.amount;
        if(x.method === "credit") credit += x.amount;
      }
      return { total, cash, debit, credit };
    }

    function applyFilters(){
      const q = el("q").value.trim().toLowerCase();
      const fMethod = el("fMethod").value;
      const fOwner = el("fOwner").value;
      const mKey = currentMonthKey();

      let items = txAll.filter(x => x.month === mKey);

      if(q) items = items.filter(x => (x.concept || "").toLowerCase().includes(q));
      if(fMethod) items = items.filter(x => x.method === fMethod);
      if(fOwner) items = items.filter(x => x.owner === fOwner);

      items.sort((a,b) => (b.dateISO + b.id).localeCompare(a.dateISO + a.id));
      return items;
    }

    function renderHome(){
      const items = applyFilters();
      const stats = computeMonthStats(items);

      el("monthTotal").textContent = fmtMoney(stats.total);
      el("monthSub").textContent = `${items.length} movimiento${items.length===1?"":"s"}`;
      el("kpiCash").textContent = fmtMoney(stats.cash);
      el("kpiDebit").textContent = fmtMoney(stats.debit);
      el("kpiCredit").textContent = fmtMoney(stats.credit);

      const list = el("list");
      list.innerHTML = "";
      el("emptyHint").style.display = items.length ? "none" : "block";

      for(const x of items){
        const div = document.createElement("div");
        div.className = "item";

        const left = document.createElement("div");
        const top = document.createElement("div");
        top.className = "top";

        const concept = document.createElement("div");
        concept.style.fontWeight = "900";
        concept.textContent = x.concept || "(sin concepto)";

        const t1 = document.createElement("span");
        t1.className = "tag";
        t1.textContent = METHOD[x.method] || x.method;

        const t2 = document.createElement("span");
        t2.className = "tag";
        t2.textContent = `Pagó: ${PERSON[x.payer] || x.payer}`;

        const t3 = document.createElement("span");
        t3.className = "tag";
        t3.textContent = `Fue de: ${PERSON[x.owner] || x.owner}`;

        if(x.source){
          const t4 = document.createElement("span");
          t4.className = "tag";
          t4.textContent = x.source === "fixed" ? "Fijo" : (x.source === "msi" ? "MSI" : x.source);
          top.appendChild(t4);
        }

        top.appendChild(concept);
        top.appendChild(t1);
        top.appendChild(t2);
        top.appendChild(t3);

        const meta = document.createElement("div");
        meta.className = "meta";
        const datePretty = new Date(x.dateISO + "T00:00:00").toLocaleDateString("es-MX", { weekday:"short", day:"2-digit", month:"short" });
        meta.textContent = `${datePretty}${x.note ? " · " + x.note : ""}`;

        left.appendChild(top);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.textAlign = "right";

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = fmtMoney(x.amount);

        const del = document.createElement("button");
        del.className = "btn small danger";
        del.textContent = "Eliminar";
        del.onclick = async () => {
          if(confirm("¿Eliminar este movimiento?")){
            await dbDel(STORE_TX, x.id);
            await loadAll();
          }
        };

        right.appendChild(amt);
        right.appendChild(document.createElement("div")).style.height = "8px";
        right.appendChild(del);

        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      }
    }

    async function saveExpense(){
      const amount = parseAmount(el("amount").value);
      const dateISO = el("date").value || todayISO();
      const concept = el("concept").value.trim();
      const method = el("method").value;
      const payer = el("payer").value;
      const owner = el("owner").value;
      const note = el("note").value.trim();

      if(!Number.isFinite(amount) || amount <= 0){ alert("Pon un monto válido (mayor a 0)."); return; }
      if(!dateISO){ alert("Selecciona una fecha."); return; }

      const d = new Date(dateISO + "T00:00:00");
      const obj = {
        id: uid(),
        type: "expense",
        source: "manual",
        amount,
        concept,
        dateISO,
        month: monthKey(d),
        method,
        payer,
        owner,
        note,
        createdAt: Date.now()
      };

      await dbPut(STORE_TX, obj);

      el("amount").value = "";
      el("concept").value = "";
      el("note").value = "";
      el("method").value = "cash";
      el("payer").value = "me";
      el("owner").value = "me";
      el("date").value = todayISO();

      closeModal("modalExpense");
      await loadAll();
    }

    /**************
     * Fixed expenses
     **************/
    function renderFixed(){
      const list = el("fixedList");
      list.innerHTML = "";
      const active = fixedAll.filter(x => x.active !== false);
      el("fixedEmpty").style.display = active.length ? "none" : "block";

      for(const f of active){
        const div = document.createElement("div");
        div.className = "item";

        const left = document.createElement("div");
        const top = document.createElement("div");
        top.className = "top";

        const name = document.createElement("div");
        name.style.fontWeight = "900";
        name.textContent = f.name;

        const t1 = document.createElement("span");
        t1.className = "tag";
        t1.textContent = `Día: ${f.day}`;

        const t2 = document.createElement("span");
        t2.className = "tag";
        t2.textContent = METHOD[f.method] || f.method;

        top.appendChild(name);
        top.appendChild(t1);
        top.appendChild(t2);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = "Se puede generar como movimiento del mes con un botón.";

        left.appendChild(top);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.textAlign = "right";

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = fmtMoney(f.amount);

        const del = document.createElement("button");
        del.className = "btn small danger";
        del.textContent = "Eliminar";
        del.onclick = async () => {
          if(confirm(`¿Eliminar "${f.name}"?`)){
            await dbDel(STORE_FIXED, f.id);
            await loadAll();
            renderFixed();
          }
        };

        right.appendChild(amt);
        right.appendChild(document.createElement("div")).style.height = "8px";
        right.appendChild(del);

        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      }
    }

    async function saveFixed(){
      const name = el("fixedName").value.trim();
      const amount = parseAmount(el("fixedAmount").value);
      const day = Number(el("fixedDay").value);
      const method = el("fixedMethod").value;

      if(!name){ alert("Pon un nombre."); return; }
      if(!Number.isFinite(amount) || amount <= 0){ alert("Monto inválido."); return; }
      if(!Number.isFinite(day) || day < 1 || day > 31){ alert("Día inválido (1-31)."); return; }

      const obj = {
        id: uid(),
        name,
        amount,
        day,
        method,
        active: true,
        createdAt: Date.now()
      };

      await dbPut(STORE_FIXED, obj);

      el("fixedName").value = "";
      el("fixedAmount").value = "";
      el("fixedDay").value = "";
      el("fixedMethod").value = "cash";

      closeModal("modalFixed");
      await loadAll();
      renderFixed();
    }

    function txExistsForFixedThisMonth(fixedId, mKey){
      return txAll.some(t => t.source === "fixed" && t.refId === fixedId && t.month === mKey);
    }

    async function generateFixedThisMonth(){
      const mKey = currentMonthKey();
      const { y, m } = currentYearMonth();

      let created = 0;

      for(const f of fixedAll.filter(x => x.active !== false)){
        if(txExistsForFixedThisMonth(f.id, mKey)) continue;

        const day = Math.min(Math.max(f.day,1), 28) + (f.day > 28 ? 0 : 0); // simple iOS-safe (evita días raros)
        const dateISO = `${y}-${pad2(m)}-${pad2(Math.min(f.day, 28))}`;

        const obj = {
          id: uid(),
          type: "expense",
          source: "fixed",
          refId: f.id,
          amount: f.amount,
          concept: f.name,
          dateISO,
          month: mKey,
          method: f.method,
          payer: "me",
          owner: "me",
          note: "Generado desde Gastos fijos",
          createdAt: Date.now()
        };

        await dbPut(STORE_TX, obj);
        created++;
      }

      await loadAll();
      alert(created ? `Listo: se generaron ${created} fijo(s) para este mes.` : "No se generó nada (ya estaban generados o no hay fijos).");
      renderHome();
    }

    /**************
     * MSI
     **************/
    function renderMSI(){
      const list = el("msiList");
      list.innerHTML = "";
      const active = msiAll.filter(x => x.active !== false);
      el("msiEmpty").style.display = active.length ? "none" : "block";

      for(const msi of active){
        const div = document.createElement("div");
        div.className = "item";

        const left = document.createElement("div");
        const top = document.createElement("div");
        top.className = "top";

        const name = document.createElement("div");
        name.style.fontWeight = "900";
        name.textContent = msi.name;

        const remaining = Math.max(0, msi.totalMonths - msi.paidMonths);

        const t1 = document.createElement("span");
        t1.className = "tag";
        t1.textContent = `Pagados: ${msi.paidMonths}/${msi.totalMonths}`;

        const t2 = document.createElement("span");
        t2.className = "tag";
        t2.textContent = `Faltan: ${remaining}`;

        const t3 = document.createElement("span");
        t3.className = "tag";
        t3.textContent = METHOD[msi.method] || msi.method;

        top.appendChild(name);
        top.appendChild(t1);
        top.appendChild(t2);
        top.appendChild(t3);

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = "“Pagar mes” agrega el movimiento del mes y avanza el contador.";

        left.appendChild(top);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.textAlign = "right";

        const amt = document.createElement("div");
        amt.className = "amt";
        amt.textContent = fmtMoney(msi.monthly);

        const pay = document.createElement("button");
        pay.className = "btn small ok";
        pay.textContent = "Pagar mes";
        pay.disabled = remaining <= 0;
        pay.onclick = async () => {
          await payMSIMonth(msi.id);
        };

        const del = document.createElement("button");
        del.className = "btn small danger";
        del.textContent = "Eliminar";
        del.onclick = async () => {
          if(confirm(`¿Eliminar "${msi.name}"?`)){
            await dbDel(STORE_MSI, msi.id);
            await loadAll();
            renderMSI();
          }
        };

        right.appendChild(amt);
        right.appendChild(document.createElement("div")).style.height = "8px";
        right.appendChild(pay);
        right.appendChild(document.createElement("div")).style.height = "8px";
        right.appendChild(del);

        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      }
    }

    async function saveMSI(){
      const name = el("msiName").value.trim();
      const monthly = parseAmount(el("msiMonthly").value);
      const totalMonths = Number(el("msiTotal").value);
      const paidMonths = Number(el("msiPaid").value || 0);
      const method = el("msiMethod").value;

      if(!name){ alert("Pon un nombre."); return; }
      if(!Number.isFinite(monthly) || monthly <= 0){ alert("Pago mensual inválido."); return; }
      if(!Number.isFinite(totalMonths) || totalMonths <= 0){ alert("Meses totales inválidos."); return; }
      if(!Number.isFinite(paidMonths) || paidMonths < 0 || paidMonths > totalMonths){ alert("Meses pagados inválidos."); return; }

      const obj = {
        id: uid(),
        name,
        monthly,
        totalMonths,
        paidMonths,
        method,
        active: true,
        createdAt: Date.now()
      };

      await dbPut(STORE_MSI, obj);

      el("msiName").value = "";
      el("msiMonthly").value = "";
      el("msiTotal").value = "";
      el("msiPaid").value = "";
      el("msiMethod").value = "credit";

      closeModal("modalMSI");
      await loadAll();
      renderMSI();
    }

    function txExistsForMSIThisMonth(msiId, mKey){
      return txAll.some(t => t.source === "msi" && t.refId === msiId && t.month === mKey);
    }

    async function payMSIMonth(msiId){
      const mKey = currentMonthKey();
      const msi = msiAll.find(x => x.id === msiId);
      if(!msi) return;

      if(txExistsForMSIThisMonth(msiId, mKey)){
        alert("Ya registraste el pago de este MSI este mes.");
        return;
      }

      if(msi.paidMonths >= msi.totalMonths){
        alert("Ya está completado.");
        return;
      }

      const dateISO = todayISO();

      // 1) create movement
      const tx = {
        id: uid(),
        type: "expense",
        source: "msi",
        refId: msiId,
        amount: msi.monthly,
        concept: `${msi.name} (MSI)`,
        dateISO,
        month: mKey,
        method: msi.method,
        payer: "me",
        owner: "me",
        note: `Pago MSI ${msi.paidMonths+1}/${msi.totalMonths}`,
        createdAt: Date.now()
      };
      await dbPut(STORE_TX, tx);

      // 2) update MSI paidMonths
      msi.paidMonths += 1;
      await dbPut(STORE_MSI, msi);

      await loadAll();
      renderMSI();
      renderHome();
    }

    /**************
     * Export / Import
     **************/
    async function exportBackup(){
      const payload = {
        app: "MisGastosPWA",
        version: 2,
        exportedAt: new Date().toISOString(),
        data: {
          tx: await dbGetAll(STORE_TX),
          fixed: await dbGetAll(STORE_FIXED),
          msi: await dbGetAll(STORE_MSI)
        }
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `mis_gastos_backup_${currentMonthKey()}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    function importBackup(){ el("file").click(); }

    async function handleImportFile(file){
      const text = await file.text();
      let payload;
      try{ payload = JSON.parse(text); }
      catch{ alert("Ese archivo no es JSON válido."); return; }

      const data = payload?.data;
      if(!data || !Array.isArray(data.tx) || !Array.isArray(data.fixed) || !Array.isArray(data.msi)){
        alert("Respaldo inválido (faltan tx/fixed/msi).");
        return;
      }

      const ok = confirm("Esto reemplazará tus datos actuales por los del respaldo.\n\n¿Continuar?");
      if(!ok) return;

      await dbClearAll();

      for(const obj of data.tx){
        if(obj && obj.id && obj.dateISO && typeof obj.amount === "number"){
          await dbPut(STORE_TX, obj);
        }
      }
      for(const obj of data.fixed){
        if(obj && obj.id && obj.name && typeof obj.amount === "number"){
          await dbPut(STORE_FIXED, obj);
        }
      }
      for(const obj of data.msi){
        if(obj && obj.id && obj.name && typeof obj.monthly === "number"){
          await dbPut(STORE_MSI, obj);
        }
      }

      await loadAll();
      alert("Listo: respaldo importado.");
      renderHome();
    }

    /**************
     * Modal helpers
     **************/
    function openModal(id){ el(id).classList.add("open"); }
    function closeModal(id){ el(id).classList.remove("open"); }

    /**************
     * Load all + render current view
     **************/
    async function loadAll(){
      txAll = await dbGetAll(STORE_TX);
      fixedAll = await dbGetAll(STORE_FIXED);
      msiAll = await dbGetAll(STORE_MSI);
    }

    /**************
     * Service Worker
     **************/
    async function registerSW(){
      if("serviceWorker" in navigator){
        try{ await navigator.serviceWorker.register("./sw.js"); }catch(e){}
      }
    }

    /**************
     * Init
     **************/
    (async function init(){
      setMonthLabel();

      el("date").value = todayISO();

      db = await openDB();
      await loadAll();
      await registerSW();

      // Drawer
      el("btnMenu").onclick = openDrawer;
      el("btnCloseMenu").onclick = closeDrawer;
      el("drawerOverlay").onclick = closeDrawer;

      el("navHome").onclick = () => setActiveNav("navHome");
      el("navFixed").onclick = () => setActiveNav("navFixed");
      el("navMSI").onclick = () => setActiveNav("navMSI");

      // Home events
      el("btnAdd").onclick = () => openModal("modalExpense");
      el("btnCloseExpense").onclick = () => closeModal("modalExpense");
      el("modalExpense").addEventListener("click", (e)=>{ if(e.target === el("modalExpense")) closeModal("modalExpense"); });
      el("btnSaveExpense").onclick = saveExpense;

      el("q").addEventListener("input", renderHome);
      el("fMethod").addEventListener("change", renderHome);
      el("fOwner").addEventListener("change", renderHome);

      el("btnGenFixedThisMonth").onclick = generateFixedThisMonth;

      // Fixed modal
      el("btnAddFixed").onclick = () => openModal("modalFixed");
      el("btnCloseFixed").onclick = () => closeModal("modalFixed");
      el("modalFixed").addEventListener("click", (e)=>{ if(e.target === el("modalFixed")) closeModal("modalFixed"); });
      el("btnSaveFixed").onclick = saveFixed;

      // MSI modal
      el("btnAddMSI").onclick = () => openModal("modalMSI");
      el("btnCloseMSI").onclick = () => closeModal("modalMSI");
      el("modalMSI").addEventListener("click", (e)=>{ if(e.target === el("modalMSI")) closeModal("modalMSI"); });
      el("btnSaveMSI").onclick = saveMSI;

      // Export/Import
      el("btnExport").onclick = exportBackup;
      el("btnImport").onclick = importBackup;

      el("file").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        e.target.value = "";
        if(f) await handleImportFile(f);
      });

      // Clear all
      el("btnClearAll").onclick = async () => {
        const ok = confirm("Esto borra TODO (movimientos, fijos y MSI) en este dispositivo.\n¿Seguro?");
        if(!ok) return;
        await dbClearAll();
        await loadAll();
        setActiveNav("navHome");
        renderHome();
      };

      // Initial render
      renderHome();
    })();
  </script>
</body>
</html>
